Component({
  data: {
    list: [],
    hammerMace: false,
    isSmashing: false,
    activeIndex: -1,
    hammerPosX: 0,
    hammerPosY: 0,
    // 以下数字标识金蛋状态
    STATE_BROKEN: 0, // 已经砸过
    STATE_STILL: 1, // 静止不动
    STATE_JUMPING: 2, // 正在跳动
    STATE_SMASHING: 3 // 正在被砸
  },
  props: {
    eggsCount: 9, // 金蛋个数
    eggCol: 3, // 金蛋列数
    eggWidth: 200, // 金蛋大小，单位 rpx
    hammerWidth: 100, // 锤子大小， 单位 rpx
    eggMarginTop: 20, // 金蛋上边距
    hammerOriginX: -20, // 锤子原点距离组件右上顶点的偏移 X，左正右负，单位 rpx
    hammerOriginY: 0, // 锤子原点距离组件右上顶点的偏移 Y，下正上负，单位 rpx
    jumpingInterval: 600, // 金蛋跳动间隔，单位 ms
    smashingDuration: 1500, // 砸金蛋持续时间，单位 ms
    className: '', // 自定义类名
    disabled: false, // 是否进行游戏
    onStart: function onStart() {}, // 砸金蛋开始的回调
    onFinish: function onFinish() {}, // 砸金蛋结束的回调
    hammerIcon: 'https://gw.alipayobjects.com/zos/rmsportal/XgogyVJXSBVXPxbTOFDK.png', // 锤子图标
    eggIcon: 'https://gw.alipayobjects.com/zos/rmsportal/TaqyxvdUFYgIwFxMuaRL.png', // 金蛋图标
    jumpIcon: 'https://gw.alipayobjects.com/zos/rmsportal/mTqmImAsoDZNmkdvuooP.png', // 金蛋跳动的图标
    redBagIcon: 'https://gw.alipayobjects.com/zos/rmsportal/OgfiOSzclCukkGfwbaGw.png', // 金蛋被砸的图标
    smashedIcon: 'https://gw.alipayobjects.com/zos/rmsportal/bItnDJuMaqJPBeKfhkMG.png' // 金蛋砸碎的图标
  },
  didMount: function didMount() {
    var list = [];
    for (var i = 0; i < this.props.eggsCount; i++) {
      list.push(1);
    }
    this.setData({ list: list });
    this.run();
  },
  didUpdate: function didUpdate(prevProps) {
    if (this.props.disabled) {
      this.stop();
    } else if (prevProps.disabled) {
      this.run();
    }
  },


  methods: {
    run: function run() {
      if (this.props.disabled) return;
      if (!this.hammerTimer) {
        this.eggsTimer = this.jumping(this.props.jumpingInterval); // 金蛋跳动
        this.hammerTimer = this.maceAnim(400);
      }
    },
    jumping: function jumping(ts) {
      var _this = this;

      // 金蛋跳动
      return setInterval(function () {
        var list = _this.data.list;
        var aIndex = _this.data.activeIndex; // 当前跳起的金蛋下标 activeIndex
        var cIndex = (aIndex + 1) % list.length; // 金蛋下标 currentIndex
        // 获取下一个没有被砸的金蛋的下标
        for (var i = 0; i < list.length; i++) {
          if (list[cIndex] === 1) {
            list[cIndex] = _this.data.STATE_JUMPING;
            list[aIndex] === _this.data.STATE_JUMPING && (list[aIndex] = _this.data.STATE_STILL);
            _this.setData({
              list: list,
              activeIndex: cIndex
            });
            break;
          }
          cIndex = (cIndex + 1) % list.length;
        }
      }, ts);
    },
    onHiting: function onHiting(e) {
      !this.props.disabled && this.start();
    },
    maceMoving: function maceMoving() {
      // 锤子移动到金蛋位置
      // 计算锤子移动的目标位置
      var index = this.data.activeIndex;
      var col = +this.props.eggCol;
      var eggWidth = +this.props.eggWidth;
      var hammerWidth = +this.props.hammerWidth;
      var marginTop = +this.props.eggMarginTop;

      var offsetX = 0.3 * (eggWidth - hammerWidth);
      var offsetY = 0.3 * (eggWidth - hammerWidth);
      var x = (col - 1 - index % col) * eggWidth + offsetX;
      var y = Math.floor(index / col) * (eggWidth + marginTop) + offsetY;
      this.setData({
        hammerPosX: x,
        hammerPosY: y
      });
    },
    hammerHoming: function hammerHoming() {
      // 锤子归位
      this.setData({
        hammerPosX: this.props.hammerOriginX,
        hammerPosY: this.props.hammerOriginY
      });
    },
    maceAnim: function maceAnim(ts) {
      var _this2 = this;

      // 锤子动画
      return setInterval(function () {
        _this2.setData({
          hammerMace: !_this2.data.hammerMace
        });
      }, ts);
    },
    smashing: function smashing() {
      // 砸金蛋过程
      var list = this.data.list;
      var index = this.data.activeIndex;
      list[index] = this.data.STATE_SMASHING;
      // 设置红包金蛋背景
      this.setData({
        list: list
      });
    },
    brocken: function brocken() {
      // 金蛋砸碎
      var index = this.data.activeIndex;
      this.data.list[index] = this.data.STATE_BROKEN;
      this.setData({
        list: this.data.list
      });
    },
    clear: function clear() {
      clearInterval(this.eggsTimer);
      clearInterval(this.hammerTimer);
      this.hammerTimer = this.eggsTimer = null;
    },
    stop: function stop() {
      // 中止游戏
      this.clear();
    },
    start: function start() {
      var _this3 = this;

      // 开始砸蛋
      this.clear();
      this.maceMoving();
      this.smashing();
      this.hammerTimer = this.maceAnim(80);
      this.setData({
        isSmashing: true
      });
      setTimeout(function () {
        _this3.done();
      }, this.props.smashingDuration);
      this.props.onStart();
    },
    done: function done() {
      var _this4 = this;

      // 结束砸蛋
      this.brocken();
      this.clear();
      this.hammerHoming();
      this.setData({
        isSmashing: false
      });
      setTimeout(function () {
        _this4.run();
      }, 500);
      this.props.onFinish();
    }
  }
});